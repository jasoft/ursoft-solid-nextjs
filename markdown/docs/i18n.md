# 多语言 (i18n) 实现与架构指南

本项目采用 **Cloudflare Workers (边缘侧路由)** + **Next.js Static Export (SSG)** 的混合架构来实现全球化支持。

## 1. 核心架构

### 1.1 路由分发 (Cloudflare Worker)
所有的路由决策均在边缘侧完成，而不是在客户端 JS 中。
- **重定向**：访问不带语言前缀的旧路径（如 `/support`）时，Worker 根据 Cookie > Accept-Language > Default 的顺序进行 302 重定向。
- **反向代理**：访问带语言前缀的路径（如 `/zh/support`）时，Worker 将其代理到 Pages 的对应 HTML 文件，同时**自动设置/更新** `preferredLocale` Cookie。
- **根域名规范化**：`ursoftware.com` 强制 301 跳转到 `www.ursoftware.com`。

### 1.2 静态生成 (Next.js)
- 使用 `output: 'export'`。
- 路径结构为 `/[locale]/[path]`。
- 翻译数据存储在 `messages/*.json` 中。

## 2. 增加新语言的 SOP

当需要增加一种新语言（例如 `ar`）时，请严格执行以下步骤：

1.  **基础配置**：
    - 更新根目录 `i18n.ts`：将 `ar` 加入 `locales` 数组。
    - 更新 `lib/i18n.ts`：将 `ar` 加入 `locales` 数组，并在 `normalizeLocale` 和 `detectLocaleByIp` 中增加映射逻辑。
2.  **边缘侧配置**：
    - 更新 `workers/locale-redirect-worker.js`：将 `ar` 加入 `LOCALES` 数组。
3.  **翻译内容**：
    - 复制 `messages/en.json` 为 `messages/ar.json`。
    - 翻译关键字段（Hero, Pricing, HeaderMenu）。
    - 运行 `npm run check` 验证 JSON 结构一致性。
4.  **发布流程**：
    - **Step 1**: 执行 `git push`。
    - **Step 2**: 等待 Cloudflare Pages 构建成功（状态为 Active）。
    - **Step 3**: 进入 `workers/` 目录运行 `npx wrangler deploy` 更新 Worker。

## 3. 避坑指南 (Lessons Learned)

### ⚠️ 禁止客户端重定向
**陷阱**：在客户端组件（如 `useEffect`）中使用正则匹配路径并执行 `router.replace`。
**后果**：当新增语言时，如果正则列表未更新，前端 JS 会误认为新语言路径非法，从而将用户跳回默认语言（如 `/ko` 跳到 `/en/ko`），导致 404 或死循环。
**方案**：已移除 `LanguageRedirect.tsx`。所有重定向逻辑必须且只能存在于边缘 Worker 中。

### ⚠️ 链接本地化
**陷阱**：在 Footer 或 Header 中使用硬编码的 `/support` 链接。
**后果**：即使在 `/ko` 页面，点击链接也会跳到根路径，触发 Worker 再次计算语言，可能导致语言跳变。
**方案**：所有内部链接必须使用 `withLocalePrefix(path, locale)`。Header 和 Footer 必须接收 `locale` 作为 prop。

### ⚠️ 部署顺序
**陷阱**：先更新 Worker，再更新 Pages。
**后果**：Worker 开始放行新语言流量（如 `/ko`），但 Pages 还没构建完，用户会看到 404。
**方案**：**永远先 Push 代码等构建，再 Deploy Worker。**

### ⚠️ 缓存回环 (522 错误)
**陷阱**：Worker 在请求自定义域名时产生回环。
**后果**：Worker 拦截了域名 A，又去 fetch 域名 A，导致无限递归。
**方案**：在 Worker 中使用 `proxyToOrigin` 辅助函数，显式将目标 Host 改写为 Cloudflare Pages 的原始域名（`*.pages.dev`）。

### ⚠️ 粘滞性丢失
**陷阱**：只在点击切换语言时设置 Cookie。
**后果**：用户直接访问 `/ko` 页面不会产生 Cookie，下次访问通用链接时会丢失语言偏好。
**方案**：Worker 在处理任何带有合法 locale 前缀的请求时，会自动在 Response 中注入 `Set-Cookie`。

## 4. 常用维护命令

- `npm run check`: 运行全量体检（Lint + 类型检查 + i18n 一致性 + 构建测试）。
- `node scripts/check-i18n-consistency.js`: 仅检查多语言 JSON 文件结构。
- `node scripts/remove-json-key.js <key>`: 批量删除所有语言文件中的冗余键值。
